<!DOCTYPE html>
    <html lang="en">
    <head>
    <meta charset="UTF-8">
    <title>Admin Dashboard ‚Äì MediaBuzz365</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        /* LIMIT TEXT HEIGHT */
.news-body h4{
 display:-webkit-box;
 -webkit-line-clamp:2;
 -webkit-box-orient:vertical;
 overflow:hidden;
}

.news-body p{
 display:-webkit-box;
 -webkit-line-clamp:3;
 -webkit-box-orient:vertical;
 overflow:hidden;
}

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    /* LAYOUT */
    .wrapper {
      display: flex;
      min-height: 100vh;
    }

    /* SIDEBAR */
    .sidebar {
      width: 260px;
      background: linear-gradient(180deg, #1a1f35 0%, #0f1419 100%);
      color: #fff;
      padding: 30px 20px;
      box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
    }

    .sidebar h2 {
      margin-bottom: 40px;
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, #e31e24 0%, #ff6b6b 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .sidebar button {
      width: 100%;
      padding: 14px 16px;
      margin-bottom: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #fff;
      cursor: pointer;
      text-align: left;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar button:hover {
      background: linear-gradient(135deg, #e31e24 0%, #ff4757 100%);
      transform: translateX(5px);
      box-shadow: 0 4px 15px rgba(227, 30, 36, 0.4);
    }

    /* MAIN */
    .main {
      flex: 1;
      padding: 40px;
      overflow-y: auto;
      margin-left:260px;
    }

    /* STATS */
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat {
      background: rgba(255, 255, 255, 0.95);
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .stat:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.18);
    }

    .stat h3 {
      font-size: 13px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .stat b {
      font-size: 32px;
      color: #1e293b;
      font-weight: 700;
      background: linear-gradient(135deg, #e31e24 0%, #ff6b6b 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* CARD */
    .card {
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 20px;
      margin-bottom: 30px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .card h3 {
      font-size: 22px;
      color: #1e293b;
      margin-bottom: 25px;
      font-weight: 700;
    }

    /* FORM */
    input, textarea, select {
      width: 100%;
      padding: 14px 16px;
      margin-top: 12px;
      margin-bottom: 16px;
      border-radius: 12px;
      border: 2px solid #e2e8f0;
      font-size: 15px;
      transition: all 0.3s ease;
      background: #fff;
      font-family: inherit;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #e31e24;
      box-shadow: 0 0 0 3px rgba(227, 30, 36, 0.1);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    input[type="file"] {
      padding: 10px;
      border: 2px dashed #e2e8f0;
      background: #f8fafc;
      cursor: pointer;
    }

    input[type="file"]:hover {
      border-color: #e31e24;
      background: #fff;
    }

    .save-btn {
      margin-top: 10px;
      margin-right: 10px;
      padding: 14px 28px;
      background: linear-gradient(135deg, #e31e24 0%, #ff4757 100%);
      color: #fff;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(227, 30, 36, 0.3);
    }

    .save-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(227, 30, 36, 0.4);
    }

    .save-btn:active {
      transform: translateY(0);
    }

    .save-btn.cancel {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
    }

    .save-btn.cancel:hover {
      box-shadow: 0 6px 20px rgba(107, 114, 128, 0.4);
    }

    .save-btn.preview {
      background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
      box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
    }

    .save-btn.preview:hover {
      box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4);
    }

    /* NEWS */
    #newsList {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .news-card {
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      border: 1px solid #f1f5f9;
    }

    .news-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
    }


    .news-card img {
      width: 100%;
      height: 180px;
      object-fit: contain;
      background:#f1f5f9;
    }

    .news-card{
 display:flex;
 flex-direction:column;
}

.news-body{
 flex:1;
 display:flex;
 flex-direction:column;
 justify-content:space-between;
}


    .news-card:hover img {
      transform: scale(1.05);
    }

    .news-body {
      padding: 16px;
    }

    .news-body h4 {
      margin: 10px 0 8px 0;
      font-size: 16px;
      color: #1e293b;
      line-height: 1.4;
      font-weight: 600;
    }

    .news-body p {
      color: #64748b;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .news-body small {
      color: #94a3b8;
      font-size: 12px;
    }

    .badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 11px;
      color: #fff;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .breaking { background: linear-gradient(135deg, #e31e24 0%, #ff4757 100%); }
    .national { background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%); }
    .international { background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%); }
    .politics { background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%); }
    .crime { background: linear-gradient(135deg, #dc2626 0%, #f87171 100%); }
    .lifestyle { background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%); }
    .technology { background: linear-gradient(135deg, #0891b2 0%, #22d3ee 100%); }
    .sports { background: linear-gradient(135deg, #ea580c 0%, #fb923c 100%); }
    .cinema { background: linear-gradient(135deg, #9333ea 0%, #c084fc 100%); }
    .business { background: linear-gradient(135deg, #059669 0%, #34d399 100%); }
    .health { background: linear-gradient(135deg, #9333ea 0%, #a855f7 100%); }

    .actions {
      margin-top: 14px;
      display: flex;
      gap: 8px;
    }

    .btn-small {
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.3s ease;
      flex: 1;
    }

    .btn-gray {
      background: #f1f5f9;
      color: #475569;
    }

    .btn-gray:hover {
      background: #e2e8f0;
      transform: translateY(-2px);
    }

    .btn-red {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: #fff;
    }

    .btn-red:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    /* PREVIEW MODAL */
    .preview-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
      overflow-y: auto;
    }

    .preview-overlay.show {
      display: flex;
    }

    .preview-container {
      background: #fff;
      border-radius: 16px;
      width: 100%;
      max-width: 1200px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .preview-header {
      background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
      color: #fff;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 16px 16px 0 0;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .preview-header h2 {
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .preview-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: #fff;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .preview-close:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    .preview-content {
      padding: 30px;
      background: #f5f5f5;
    }

    .preview-banner {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .preview-label {
      font-size: 13px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .preview-main-image {
      width: 100%;
      height: auto;
      border-radius: 8px;
      margin-bottom: 16px;
      background: #f3f4f6;
      object-fit: contain;
    }

    .preview-category {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      color: #fff;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .preview-title {
      font-size: 24px;
      font-weight: 700;
      color: #1e293b;
      line-height: 1.4;
      margin-bottom: 12px;
      font-family: 'Noto Sans Telugu', sans-serif;
    }

    .preview-description {
      font-size: 16px;
      color: #64748b;
      line-height: 1.6;
      margin-bottom: 12px;
      font-family: 'Noto Sans Telugu', sans-serif;
    }

    .preview-meta {
      display: flex;
      gap: 20px;
      font-size: 14px;
      color: #94a3b8;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }

    .preview-sidebar-card {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .preview-sidebar-image {
      width: 100px;
      height: 75px;
      object-fit: contain;
      border-radius: 6px;
      background: #f3f4f6;
      flex-shrink: 0;
    }

    .preview-sidebar-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      line-height: 1.4;
      font-family: 'Noto Sans Telugu', sans-serif;
    }

    .preview-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .preview-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .wrapper {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }

      .main {
        padding: 20px;
      }

      .stats {
        grid-template-columns: 1fr;
      }

      #newsList {
        grid-template-columns: 1fr;
      }
    }
        .sidebar{
      width:260px;
      height:100vh;
      background:linear-gradient(180deg,#020617,#0f172a);
      padding:25px 20px;
      color:white;
      box-shadow:8px 0 40px rgba(0,0,0,.6);
      position:relative;
    }

    /* BRAND */
    .brand{
      text-align:center;
      margin-bottom:40px;
    }

    .logo-wrap{
      width:110px;
      height:110px;
      margin:auto;
      border-radius:50%;
      background:linear-gradient(135deg,#ff004f,#00f0ff);
      padding:3px;
      animation:pulse 2.5s infinite;
    }

    .logo-wrap img{
      width:100%;
      height:100%;
      border-radius:50%;
      background:#000;
    }

    .brand h2{
      margin-top:12px;
      font-size:20px;
      letter-spacing:1px;
      background:linear-gradient(90deg,#ff004f,#00f0ff);
      -webkit-background-clip:text;
      color:transparent;
    }

    .brand p{
      font-size:12px;
      letter-spacing:2px;
      opacity:.7;
    }

    /* MENU */
    nav button{
      width:100%;
      padding:14px;
      margin-bottom:14px;
      border-radius:14px;
      background:rgba(255,255,255,.04);
      backdrop-filter:blur(10px);
      color:white;
      border:1px solid rgba(255,255,255,.1);
      cursor:pointer;
      font-size:15px;
      display:flex;
      gap:12px;
      align-items:center;
      transition:.35s;
      position:relative;
      overflow:hidden;
    }

    nav button::before{
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(90deg,transparent,#00f0ff,transparent);
      opacity:0;
    }

    nav button:hover::before{
      animation:shine 1.2s;
    }

    nav button:hover{
      transform:translateX(6px);
      background:linear-gradient(90deg,#ff004f,#00f0ff);
      box-shadow:0 0 25px #00f0ff;
    }

    nav button span{
      font-size:18px;
    }

    /* LOGOUT */
    .danger:hover{
      background:linear-gradient(90deg,#ff0000,#ff7300)!important;
      box-shadow:0 0 25px red;
    }

    /* ANIMATIONS */
    @keyframes pulse{
      0%{box-shadow:0 0 0 #00f0ff}
      50%{box-shadow:0 0 30px #00f0ff}
      100%{box-shadow:0 0 0 #00f0ff}
    }

    @keyframes shine{
      0%{opacity:0}
      30%{opacity:.7}
      100%{opacity:0}
    }
    .sidebar{
      position:fixed;
      left:0;
      top:0;
      height:100vh;
      width:260px;
      background:linear-gradient(180deg,#020617,#0f172a);
      padding:25px 20px;
      color:white;
      box-shadow:8px 0 40px rgba(0,0,0,.6);
      overflow-y:auto;
      z-index:100;
    }
    /* MESSAGE TOAST */
    .msg-box{
      position:fixed;
      top:20px;
      right:20px;
      background:#111;
      color:#fff;
      padding:14px 20px;
      border-radius:12px;
      font-size:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.4);
      z-index:9999;
      display:none;
      animation:slideIn .3s ease;
    }

    .msg-box.success{background:#16a34a;}
    .msg-box.error{background:#dc2626;}
    .msg-box.warn{background:#f59e0b;}

    @keyframes slideIn{
      from{transform:translateX(50px);opacity:0}
      to{transform:translateX(0);opacity:1}
    }
    /* CONFIRM MODAL */
    .confirm-overlay{
     position:fixed;
     inset:0;
     background:rgba(0,0,0,.55);
     display:none;
     align-items:center;
     justify-content:center;
     z-index:99999;
    }

    .confirm-card{
     background:#fff;
     padding:24px;
     width:320px;
     border-radius:14px;
     text-align:center;
     animation:pop .25s ease;
    }

    .confirm-card h3{
     margin-bottom:10px;
    }

    .confirm-card p{
     color:#555;
     font-size:14px;
     margin-bottom:18px;
    }

    .confirm-actions{
     display:flex;
     justify-content:space-between;
     gap:10px;
    }

    .btn-cancel{
     flex:1;
     padding:10px;
     border:none;
     border-radius:10px;
     background:#e5e7eb;
     cursor:pointer;
    }

    .btn-ok{
     flex:1;
     padding:10px;
     border:none;
     border-radius:10px;
     background:#dc2626;
     color:#fff;
     cursor:pointer;
    }

    @keyframes pop{
     from{transform:scale(.85);opacity:0}
     to{transform:scale(1);opacity:1}
    }

    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Telugu:wght@400;600;700&display=swap" rel="stylesheet">
    </head>

    <body>

    <!-- üîê AUTH PROTECTION -->
    <script>
    if(!localStorage.getItem("token")){
     location.href="/admin/login.html";
    }
    </script>
    <!-- MESSAGE BOX -->
    <div id="msgBox" class="msg-box"></div>
    <!-- CONFIRM MODAL -->
    <div id="confirmBox" class="confirm-overlay">
     <div class="confirm-card">
      <h3>Confirm Delete</h3>
      <p id="confirmText">Are you sure?</p>

      <div class="confirm-actions">
       <button class="btn-cancel" onclick="closeConfirm()">Cancel</button>
       <button class="btn-ok" id="confirmYes">Delete</button>
      </div>
     </div>
    </div>

    <!-- PREVIEW MODAL -->
    <div id="previewOverlay" class="preview-overlay">
      <div class="preview-container">
        <div class="preview-header">
          <h2>üëÅÔ∏è Preview - How It Will Look</h2>
          <button class="preview-close" onclick="closePreview()">‚úï</button>
        </div>
        <div class="preview-content">

          <!-- Main News Card Preview -->
          <div class="preview-label">üåü Main News Card (Top News Section)</div>
          <div class="preview-banner" id="previewMainCard">
            <!-- Content populated by JavaScript -->
          </div>

          <!-- Two Column Layout -->
          <div class="preview-grid">
            <!-- Sidebar Preview -->
            <div>
              <div class="preview-label">üìã Sidebar Card (Breaking News)</div>
              <div class="preview-sidebar-card" id="previewSidebarCard">
                <!-- Content populated by JavaScript -->
              </div>
            </div>

            <!-- Side News Preview -->
            <div>
              <div class="preview-label">üì∞ Side News Card</div>
              <div class="preview-banner" id="previewSideCard">
                <!-- Content populated by JavaScript -->
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="wrapper">

    <!-- SIDEBAR -->
    <div class="sidebar">

      <div class="brand">
        <div class="logo-wrap">
          <img src="../images/mediabuzz365.png" alt="logo">
        </div>
        <h2>MediaBuzz365</h2>
        <p>Admin Panel</p>
      </div>

      <nav>
        <button onclick="navigate('add')">
          <span>‚ûï</span> Add News
        </button>
        <button onclick="navigate('list')">
          <span>üì∞</span> All News
        </button>
        <button class="danger" onclick="logout()">
          <span>üö™</span> Logout
        </button>
      </nav>

    </div>


    <!-- MAIN -->
    <div class="main">

    <!-- STATS -->
    <div class="stats">
     <div class="stat"><h3>Total News</h3><b id="totalCount">0</b></div>
     <div class="stat"><h3>Breaking News</h3><b id="breakingCount">0</b></div>
     <div class="stat"><h3>National</h3><b id="nationalCount">0</b></div>
     <div class="stat"><h3>Politics</h3><b id="politicsCount">0</b></div>
    </div>

    <!-- ADD -->
    <div class="card" id="add">
    <h3>Add / Edit News</h3>

    <select id="city"></select>


    <select id="category">
    <option value="">-- Select Category --</option>
    <option value="breaking">‡∞≤‡±á‡∞ü‡±Ü‡∞∏‡±ç‡∞ü‡±ç ‡∞®‡±ç‡∞Ø‡±Ç‡∞∏‡±ç (Breaking)</option>
    <option value="national">‡∞®‡±á‡∞∑‡∞®‡∞≤‡±ç (National)</option>
    <option value="international">‡∞á‡∞Ç‡∞ü‡∞∞‡±ç‡∞®‡±á‡∞∑‡∞®‡∞≤‡±ç (International)</option>
    <option value="politics">‡∞∞‡∞æ‡∞ú‡∞ï‡±Ä‡∞Ø‡∞æ‡∞≤‡±Å (Politics)</option>
    <option value="crime">‡∞ï‡±ç‡∞∞‡±à‡∞Ç (Crime)</option>
    <option value="lifestyle">‡∞≤‡±à‡∞´‡±ç ‡∞∏‡±ç‡∞ü‡±à‡∞≤‡±ç (Lifestyle)</option>
    <option value="technology">‡∞ü‡±Ü‡∞ï‡±ç‡∞®‡∞æ‡∞≤‡∞ú‡±Ä (Technology)</option>
    <option value="sports">‡∞ï‡±ç‡∞∞‡±Ä‡∞°‡∞≤‡±Å (Sports)</option>
    <option value="cinema">‡∞∏‡∞ø‡∞®‡∞ø‡∞Æ‡∞æ (Cinema)</option>
    <option value="business">‡∞¨‡∞ø‡∞ú‡∞ø‡∞®‡±Ü‡∞∏‡±ç (Business)</option>
    <option value="health">Health</option>
    </select>

    <input id="title" placeholder="Enter news title (Telugu or English)">
    <textarea id="description" placeholder="Enter news description"></textarea>
    <input type="file" id="image" multiple accept="image/*">


    <div>
    <button class="save-btn" onclick="saveNews()" id="saveBtn">Save News</button>
    <button class="save-btn preview" onclick="showPreview()" id="previewBtn">üëÅÔ∏è Preview</button>
    <button class="save-btn cancel" onclick="cancelEdit()" id="cancelBtn" style="display:none">Cancel</button>
    </div>
    </div>

    <!-- LIST -->
    <div class="card" id="list">
    <h3>All News Articles</h3>
    <div id="newsList"></div>
    </div>

    </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
    const API = location.hostname.includes("localhost")
     ? "http://localhost:3000"
     : "https://mediabuzz365.in";

    let allNews=[];
    let editMode=false;
    let editId=null;
    let deleteId=null;

    const token = localStorage.getItem("token");

    /* ========== AUTH ========= */
    if(!token){
     location.href="/admin/login.html";
    }

    /* ========== NAV ========= */
    function navigate(id){
     document.getElementById(id)
     .scrollIntoView({behavior:"smooth"});
    }

    function logout(){
     localStorage.removeItem("token");
     location.href="/admin/login.html";
    }

    /* ========== LOAD USER DISTRICTS ========= */
    function loadUserDistricts(){

     fetch(API + "/api/users/me",{
      headers:{ Authorization:"Bearer "+token }
     })
     .then(r=>r.json())
     .then(user=>{

      city.innerHTML="";

      if(!user.districts.length){
       city.innerHTML=`
        <option value="">
         No district assigned
        </option>`;
       city.disabled=true;
       return;
      }

      city.disabled=false;

      user.districts.forEach((d,i)=>{
       city.innerHTML+=`
        <option ${i===0?"selected":""}>
         ${d}
        </option>`;
      });

     });
    }

    /* ========== LOAD NEWS ========= */
    function loadNews(){
     fetch(API+"/api/news")
     .then(r=>r.json())
     .then(d=>{
      allNews=d.reverse();
      updateCounts(allNews);
      render(allNews);
     })
     .catch(()=>{
      showMsg("Failed to load","error");
     });
    }

    /* ========== COUNTS ========= */
    function updateCounts(d){
     totalCount.textContent=d.length;
     breakingCount.textContent=d.filter(n=>n.category==="breaking").length;
     nationalCount.textContent=d.filter(n=>n.category==="national").length;
     politicsCount.textContent=d.filter(n=>n.category==="politics").length;
    }

function render(data){
 newsList.innerHTML="";

 if(!data.length){
  newsList.innerHTML=
  `<p style="text-align:center;color:#64748b;padding:40px">
   No news yet
  </p>`;
  return;
 }

 data.forEach(n=>{

  let imgs = "";

  if(n.images && n.images.length){
   n.images.forEach(img=>{
    imgs += `<img src="${img}" style="width:100%;height:180px;object-fit:cover;margin-bottom:6px;border-radius:8px">`;
   });
  }else{
   imgs = `<img src="https://via.placeholder.com/280x180">`;
  }

  newsList.innerHTML+=`
  <div class="news-card">

   ${imgs}

   <div class="news-body">
    <span class="badge ${n.category}">
     ${n.category}
    </span>

    <h4>${n.title}</h4>
    <p>üìç ${n.city}</p>
    <small>
     üïê ${new Date(n.date).toLocaleString()}
    </small>

    <div class="actions">
     <button class="btn-small btn-gray"
      onclick='editNews(${JSON.stringify(n)
      .replace(/'/g,"&#39;")})'>Edit</button>

     <button class="btn-small btn-red"
      onclick="openConfirm('${n._id}')">
      Delete
     </button>
    </div>
   </div>
  </div>`;
 });
}


    /* ========== SAVE ========= */
const image = document.getElementById("image");
let selectedImages = [];

image.addEventListener("change",()=>{
 selectedImages = Array.from(image.files);

 console.log("FILES SELECTED:", selectedImages.length);
 selectedImages.forEach(f=>console.log(f.name));
});

function saveNews(){

 const form=new FormData();

 form.append("city",city.value);
 form.append("category",category.value);
 form.append("title",title.value);
 form.append("description",description.value);

 selectedImages.forEach(file=>{
  form.append("imageFiles",file);
 });

 // DEBUG
 for(let p of form.entries()){
  console.log(p[0], p[1].name || p[1]);
 }

 fetch(API+"/api/news",{
  method:"POST",
  headers:{
   Authorization:"Bearer "+token
  },
  body:form
 })
 .then(r=>r.json())
 .then(d=>{
  console.log(d);
  alert("Uploaded");
 });
}

    /* ========== PREVIEW ========= */
    function showPreview() {
      const cityVal = city.value;
      const categoryVal = category.value;
      const titleVal = title.value;
      const descVal = description.value;

      // Validation
      if (!categoryVal || !titleVal) {
        showMsg("Please fill category and title to preview", "warn");
        return;
      }

      // Get category name in Telugu
      const categoryMap = {
        'breaking': '‡∞≤‡±á‡∞ü‡±Ü‡∞∏‡±ç‡∞ü‡±ç ‡∞®‡±ç‡∞Ø‡±Ç‡∞∏‡±ç',
        'national': '‡∞®‡±á‡∞∑‡∞®‡∞≤‡±ç',
        'international': '‡∞á‡∞Ç‡∞ü‡∞∞‡±ç‡∞®‡±á‡∞∑‡∞®‡∞≤‡±ç',
        'politics': '‡∞∞‡∞æ‡∞ú‡∞ï‡±Ä‡∞Ø‡∞æ‡∞≤‡±Å',
        'crime': '‡∞ï‡±ç‡∞∞‡±à‡∞Ç',
        'lifestyle': '‡∞≤‡±à‡∞´‡±ç ‡∞∏‡±ç‡∞ü‡±à‡∞≤‡±ç',
        'technology': '‡∞ü‡±Ü‡∞ï‡±ç‡∞®‡∞æ‡∞≤‡∞ú‡±Ä',
        'sports': '‡∞ï‡±ç‡∞∞‡±Ä‡∞°‡∞≤‡±Å',
        'cinema': '‡∞∏‡∞ø‡∞®‡∞ø‡∞Æ‡∞æ',
        'business': '‡∞¨‡∞ø‡∞ú‡∞ø‡∞®‡±Ü‡∞∏‡±ç',
        'health': 'Health'
      };

      // Get image preview URL
      let imageUrl = 'https://via.placeholder.com/800x450?text=No+Image+Selected';
      if (selectedImages && selectedImages.length > 0) {
        imageUrl = URL.createObjectURL(selectedImages[0]);
      }

      // Populate Main Card (Image Only)
      document.getElementById('previewMainCard').innerHTML = `
        <img src="${imageUrl}" class="preview-main-image" alt="Preview">
      `;

      // Populate Sidebar Card (Image Only)
      document.getElementById('previewSidebarCard').innerHTML = `
        <img src="${imageUrl}" class="preview-sidebar-image" alt="Preview">
      `;

      // Populate Side Card (Image Only)
      document.getElementById('previewSideCard').innerHTML = `
        <img src="${imageUrl}" class="preview-main-image" style="height: 180px; object-fit: contain;" alt="Preview">
      `;

      // Show modal
      document.getElementById('previewOverlay').classList.add('show');
    }

    function closePreview() {
      document.getElementById('previewOverlay').classList.remove('show');
    }

    // Close preview on overlay click
    document.getElementById('previewOverlay').addEventListener('click', function(e) {
      if (e.target === this) {
        closePreview();
      }
    });

    // Close preview on ESC key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closePreview();
      }
    });

    /* ========== EDIT ========= */
    function editNews(n){

     editMode=true;
     editId=n._id;

     city.value=n.city;
     category.value=n.category;
     title.value=n.title;
     description.value=n.description;

     saveBtn.innerHTML="Update News";
     cancelBtn.style.display="inline-block";
     navigate("add");
    }

    /* ========== CANCEL ========= */
    function cancelEdit(){

     editMode=false;
     editId=null;

     saveBtn.innerHTML="Save News";
     cancelBtn.style.display="none";

     city.selectedIndex=0;
     title.value="";
     description.value="";
     category.value="";
     image.value="";
    }

    /* ========== DELETE ========= */
    function openConfirm(id){
     deleteId=id;
     confirmBox.style.display="flex";
    }

    function closeConfirm(){
     deleteId=null;
     confirmBox.style.display="none";
    }

    function confirmDelete(){

     fetch(API+"/api/news/"+deleteId,{
      method:"DELETE",
      headers:{
       Authorization:"Bearer "+token
      }
     })
     .then(r=>{
      if(r.ok){
       showMsg("Deleted","success");
       loadNews();
      }else{
       showMsg("Delete failed","error");
      }
     })
     .finally(closeConfirm);
    }

    /* ========== TOAST ========= */
    function showMsg(text,type="success"){

     msgBox.className="msg-box "+type;
     msgBox.innerText=text;
     msgBox.style.display="block";

     setTimeout(()=>{
      msgBox.style.display="none";
     },3000);
    }

    /* ========== SOCKET ========= */
    const socket = io();

    const user = JSON.parse(
     atob(token.split(".")[1])
    );

    socket.emit("join-admin",user.id);

    socket.on("news:approved",()=>{
     showMsg("Approved!");
     loadNews();
     loadUserDistricts(); // refresh districts
    });

    socket.on("news:rejected",()=>{
     showMsg("Rejected","warn");
     loadNews();
    });

    socket.on("news:deleted",loadNews);

    /* ========== INIT ========= */
    loadUserDistricts();
    loadNews();

    confirmYes.addEventListener("click",confirmDelete);
    </script>


    </body>
    </html>